# くそざこタワーダンジョンバトル — MVP 仕様書 v3

更新日：2025-10-21  
対象：開発チーム（Codex 実装） / 企画 / アート

---

## 0. 目的・スコープ

* **目的**：現行コード／データの挙動に合わせた最新仕様を整理し、5〜10分の 1 ランのプレイ体験を保証する。
* **プレイ概要**：コマンダー（プレイヤー直接操作）＋量産ちびわふ部隊で拠点を防衛。スタンス／フォーメーション／スキルを切り替えつつ敵ウェーブをしのぐ。
* **非スコープ（MVP外）**：ネットワーク要素、リプレイ／セーブ、称号AI、音響、ミニマップ、多言語 UI（日本語テキストはビルド可だが翻訳UIは未実装）。

---

## 1. 対応環境・ツールチェーン

* **OS**：Windows 10+ / macOS 13+
* **言語**：C++17
* **描画基盤**：SDL2（ウィンドウ・入力）、SDL2_image、SDL2_ttf（HUD文字レンダリング）
* **ビルド**：CMake ≥3.24、必要パッケージ（例：Homebrew / vcpkg）で SDL2, SDL2_image, SDL2_ttf を導入
* **解像度**：固定 1280×720（内部タイル16px単位）
* **フォント**：`assets/ui/NotoSansJP-Regular.ttf`（HUD／デバッグ共通。SDL_ttf でランタイム描画）

---

## 2. ゲームループ概要

1. **初期化**：アセット読込（`game.json`, `entities.json`, `skills.json`, `spawn_level1.json`, `atlas.json`, タイルマップ `level1.tmx`）。Noto Sans JP フォントを SDL_ttf で読み込み。
2. **ゲーム進行**：固定Δt (`1/60s`) でシミュレーション。自動ちびスポーン、敵ウェーブ、戦闘、HUD 更新を行う。
3. **勝敗判定**：敵ウェーブ完了かつ敵全滅後、5s 経過で Victory。拠点HP=0 で Defeat。
4. **再挑戦**：結果表示後、`R` キーでリスタート（リスタート遅延 2s）。

---

## 3. マップ構造

* タイルサイズ：16px、80×45 視認エリア。
* レイヤ：`Floor` / `Block`（衝突）/ `Deco`。
* 主要座標（タイル基準）：
  * 拠点：`(70, 22)`
  * 敵ゲート：A=`(2,10)`、B=`(2,22)`、C=`(2,34)`
* 雰囲気演出：描画最後に暗めのビネット（半透明矩形）を重ねる。

---

## 4. エンティティと能力値

### 4.1 コマンダー（プレイヤー操作）

| パラメータ | 値 |
| --- | --- |
| 半径 | 12px |
| 当たり AABB | 24×24px |
| HP | 60 |
| DPS | 15（近接判定で敵に毎秒与ダメ）|
| 速度 | **3.2 u/s**（`pixels_per_unit`=16 → 約 51 px/s）|
| リスポーン | ベース：8s、最大追加：+10s（被ダメオーバーキル比 ×5s×k=2.0、下限12s、復活無敵2s）|
| 特殊 | 死亡時：味方全滅→順次リスポーン。即時ちび10体を自動増援。|

### 4.2 ちびわふ（味方量産ユニット）

| パラメータ | 値 |
| --- | --- |
| 半径 | 4px |
| HP | 10 |
| DPS | 3 |
| 速度 | 1.8 u/s |
| スポーン | 拠点口、0.75s 間隔、最大200体。スポーン位置に ±16px のYばらつき。|
| 透明演出 | 半径32px以内に味方が4体以上いる場合 α=0.3 に低減（視認性確保）。|

### 4.3 敵：スライム

| パラメータ | 値 |
| --- | --- |
| 半径 | 11px |
| HP | 80 |
| DPS | 5（ユニット/拠点共通）|
| 速度 | 0.9 u/s |
| 行動 | 拠点へ直進、接触で継続ダメージ。|

### 4.4 敵：ウォールブレイカー（エリート）

| パラメータ | 値 |
| --- | --- |
| 半径 | 12px |
| HP | 60 |
| 速度 | 1.0 u/s |
| DPS | 壁15 / ユニット5 / 拠点5 |
| 特性 | ノックバック無視、半径256px内に壁があれば最優先攻撃。|

---

## 5. 戦闘処理

* すべて円×円衝突（拠点のみ AABB）。
* 接触中に DPS/秒で継続ダメージ。
* Y 座標でソートして描画（簡易奥行き）。
* 味方密集時はアルファ低減（前述）。
* LOD 設定：総エンティティ 300 超で `skip_draw_every=2` を適用（隔フレーム描画）。

---

## 6. 全軍スタンス

ショートカット：`F1`〜`F4`

| スタンス | 挙動 |
| --- | --- |
| Rush Nearest | 最寄りの敵に突撃。|
| Push Forward | 前線ウェイポイントへ推進、敵遭遇で戦闘。|
| Follow Leader | コマンダー追従。追従上限30体（超過分は近場行動）。フォーメーション適用。|
| Defend Base | 拠点周囲を周回防衛。|

スタンス切替時は HUD テレメトリにメッセージを表示（3s）。

---

## 7. フォーメーション（Follow Stance 時）

ショートカット：`Z`（前）/`X`（次）

| 名称 | 特徴 |
| --- | --- |
| Swarm | 散開（R=48px）。|
| Wedge | 三角陣。行ごとに前進。|
| Line | 横列（等間隔 24px）。|
| Ring | 半径40px の環状。|

選択時、HUD テレメトリに通知（3s）。

---

## 8. スキル（選択1〜4 / 右クリック発動）

| Hotkey | 名称 | 効果 | CD | 備考 |
| --- | --- | --- | --- | --- |
| 1 | Rally | 半径160px 内のちび追従 ON/OFF。| 3s | トグル時テレメトリ表示。|
| 2 | Wall | タイル8マスに壁段生成。近傍ちび8体が壁化（HP10/段、寿命20s）。| 15s | 壁優先攻撃の敵に対抗。|
| 3 | Surge | 20s 間ちびスポーン倍率 1.5。| 40s | HUD のスキル行に残り時間表示。|
| 4 | Self Destruct | 半径128px に80ダメ＋ノックバック。コマンダー即死。| 60s | リスポーンペナルティ2倍、10s 間スポーン遅延×2。ただし命中1体ごとリスポーン短縮0.5s（最大6s）。|

選択：`1`〜`4`、発動：マウス右クリック地点。

---

## 9. リスポーン

* ちび：`t = 5s + overkill_ratio × 5s`（clamp 0..3 → 5〜20s）。復活無敵 2s。
* コマンダー：`t = max(12s, 8s + overkill_ratio × 10s)`、復活無敵2s。死亡時点のちび全員が死亡扱いになり、各自リスポーンキューへ。追加でちび10体が即時復帰。

overkill_ratio = `clamp( (過撃ダメ) / 最大HP, 0..3 )`

---

## 10. 敵ウェーブ（`assets/spawn_level1.json`）

* 敵ゲート A/B/C からスポーン。`y_jitter_px = 8`
* ウェーブ構成：
  1. t=0：A×3、B×3（テロップ「左から敵！」）
  2. t=15：A×4、C×2
  3. t=30：B×6（「増援が接近！」）
  4. t=60：A×6、C×6、Bに壁割り×1（「左右から敵！ 壁を壊す敵接近！」）
  5. t=90：B×8
  6. t=120：A×6、B×6、C×6、Bに壁割り×1（「総攻撃！」）

各セットは 0.2〜0.3s の間隔で連続スポーン。

---

## 11. UI・入力

* **移動**：WASD / 矢印。`Space`＝コマンダーへカメラスナップ。`Tab`＝拠点へスナップ。
* **スタンス**：`F1`〜`F4`（前述）。
* **フォーメーション**：`Z` / `X`。
* **スキル選択**：`1`〜`4`。**発動**：マウス右クリック。
* **その他**：`Esc` 終了、`R` リスタート（結果閲覧後のみ）、`F10` デバッグHUD切替。
* **HUD**：
  * 上部中央：拠点 HP バー（背景＋枠 + 数値）。
  * 左上パネル：味方数、コマンダー HP、敵数、スタンス／フォーメーション、スキル一覧（クールダウン表示・アクティブタイマー表示）。
  * 右上：テレメトリ（ウェーブ通知）、F10 で性能パネル（FPS、エンティティ数、Update/Render 時間、Draw Calls）。
  * 中央：Victory/Defeat 時のテキスト（半透明背景付き）。
  * フォント：Noto Sans JP（メイン22pt / デバッグ18pt）。SDL_ttf で都度レンダリング。メトリクス／字間はライブラリ準拠。

---

## 12. パフォーマンス・ログ

* フレーム毎に SDL `SDL_GetPerformanceCounter` で Update/Render の実時間を計測。
* 1 秒ごとに平均 FPS・Update ms・Render ms・エンティティ数を `stdout` へログ（閾値9ms超で★付与）。
* HUD デバッグパネルには現在値のみを表示。

---

## 13. データファイル一覧

| パス | 役割 |
| --- | --- |
| `assets/game.json` | ゲームループ設定（Δt、マップ、スポーン、リスポーン、カメラ等）|
| `assets/entities.json` | コマンダー／味方／敵ステータス。※現在コマンダー速度 3.2 u/s |
| `assets/skills.json` | スキル定義（効果種別・CD・数値）|
| `assets/spawn_level1.json` | ウェーブ脚本（タイミング・ゲート・敵種）。|
| `assets/atlas.json` + `atlas.png` | スプライトアトラス（コマンダー／味方／敵／リング等）。|
| `assets/maps/level1.tmx` | Tiled マップデータ。|
| `assets/ui/NotoSansJP-Regular.ttf` | HUD フォント（TrueType）。|

---

## 14. 既知の仕様メモ

* 味方透過処理は視認性のための演出。調整する際は `src/main.cpp` 内 `yunaAlpha` 計算を変更。
* 壁化スキルはウォールブレイカー対策を意図。優先半径256px 以内の壁をターゲット。
* デバッグHUDは開発用。リリースビルドでは `F10` 初期値オフ。
* 音／エフェクト／チュートリアルは未実装。将来タスクとして別途管理。

---

## 15. 今後の開発検討事項（参考）

* HUD レイアウトの再設計（スキルアイコン等のビジュアル化）。
* LOD ロジック拡張（攻撃間隔の間引き等）。
* Noto Sans JP 以外の軽量フォント選択肢の検討。
* ウェーブ追加／難易度スケーリング、ステージ 2 以降のデザイン。

